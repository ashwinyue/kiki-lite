# Logstash 配置文件
# 用于接收和处理 Kiki 应用的日志

input {
  # 主 TCP 输入（JSON 格式）
  tcp {
    port => 5044
    codec => json
    type => "kiki_api"
  }

  # 备用 TCP 输入（JSON 行格式）
  tcp {
    port => 5959
    codec => json_lines
    type => "kiki_api_backup"
  }

  # 可以添加 UDP 输入用于低延迟场景
  # udp {
  #   port => 5000
  #   codec => json
  #   type => "kiki_api_udp"
  # }
}

filter {
  # 解析 JSON 消息
  if [type] == "kiki_api" or [type] == "kiki_api_backup" {
    # 提取时间戳
    if [@timestamp] {
      date {
        match => ["[@timestamp]", "ISO8601"]
        target => "@timestamp"
      }
    }

    # 添加环境标签
    mutate {
      add_field => {
        "[@metadata][index]" => "kiki-logs-%{+YYYY.MM.dd}"
        "environment" => "${ELK_ENVIRONMENT:development}"
        "service" => "kiki-api"
      }
    }

    # 处理异常信息
    if [exception] {
      mutate {
        rename => { "[exception][type]" => "[error][type]" }
        rename => { "[exception][message]" => "[error][message]" }
        rename => { "[exception][traceback]" => "[error][stack_trace]" }
      }
    }

    # 处理请求上下文
    if [context] {
      mutate {
        rename => { "[context][request_id]" => "[request][id]" }
        rename => { "[context][session_id]" => "[session][id]" }
        rename => { "[context][user_id]" => "[user][id]" }
      }
    }

    # 解析日志级别
    if [level] {
      mutate {
        uppercase => ["[level]"]
      }
    }
  }

  # 添加地理位置信息（如果有的话）
  if [client_ip] {
    geoip {
      source => "[client_ip]"
      target => "[geoip]"
    }
  }

  # 根据日志级别添加标签
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => ["error"]
    }
  }

  if [level] == "WARNING" or [level] == "WARN" {
    mutate {
      add_tag => ["warning"]
    }
  }
}

output {
  # 输出到 Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "kiki-logs-%{+YYYY.MM.dd}"
    template_name => "kiki-logs"
    template_overwrite => true
  }

  # 可选：输出到标准输出（用于调试）
  # stdout {
  #   codec => rubydebug
  # }
}
