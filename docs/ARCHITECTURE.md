# Kiki Agent Framework - æ¶æ„è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬: v0.1.0
> æ›´æ–°æ—¥æœŸ: 2025-01-30

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

Kiki Agent Framework çš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ª**ç”Ÿäº§å°±ç»ª**çš„ä¼ä¸šçº§ AI Agent å¼€å‘è„šæ‰‹æ¶ï¼Œå®ç°ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š

1. **AI åŸç”Ÿæ¶æ„** - æ·±åº¦é›†æˆ LangGraphï¼Œæ”¯æŒå¤æ‚çš„å·¥ä½œæµç¼–æ’
2. **ä¼ä¸šçº§å¯é æ€§** - å®Œæ•´çš„ç›‘æ§ã€æ—¥å¿—ã€é”™è¯¯å¤„ç†ã€é™æµæœºåˆ¶
3. **é«˜å¯æ‰©å±•æ€§** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒå¤šæ¨¡å‹ã€å¤šå·¥å…·ã€å¤š Agent
4. **å¼€å‘å‹å¥½** - ç±»å‹å®‰å…¨ã€çƒ­é‡è½½ã€å®Œå–„çš„æµ‹è¯•æ”¯æŒ

### 1.2 æ¶æ„åŸåˆ™

| åŸåˆ™ | è¯´æ˜ | å®ç° |
|------|------|------|
| **åˆ†å±‚æ¶æ„** | API/Service/Data åˆ†ç¦» | `app/api/`, `app/agent/`, `app/repositories/` |
| **ä¾èµ–æ³¨å…¥** | æ§åˆ¶åè½¬ï¼Œé™ä½è€¦åˆ | `get_settings()`, `get_llm_service()`, `get_agent()` |
| **å•ä¸€èŒè´£** | æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä»¶äº‹ | ç‹¬ç«‹çš„ Service/Repository/å·¥å…·ç±» |
| **æ¥å£éš”ç¦»** | ç»†ç²’åº¦çš„æ¥å£å®šä¹‰ | `CompiledStateGraph`, `BaseToolRegistry` |
| **å¼€é—­åŸåˆ™** | æ‰©å±•å¼€æ”¾ï¼Œä¿®æ”¹å…³é—­ | å·¥å…·æ³¨å†Œè¡¨ã€æ¨¡å‹æ³¨å†Œè¡¨ |

---

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Web UI     â”‚  â”‚  Mobile App  â”‚  â”‚  Third Party â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API Layer (FastAPI)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Middleware                                                â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ ObservabilityMiddleware (æ—¥å¿—ã€æŒ‡æ ‡)                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ RequestContextMiddleware (è¯·æ±‚ä¸Šä¸‹æ–‡)                  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€ RateLimitMiddleware (é™æµ)                            â”‚ â”‚
â”‚  â”‚  â””â”€â”€ AuthMiddleware (è®¤è¯)                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ /chat    â”‚ â”‚ /auth    â”‚ â”‚ /agents  â”‚ â”‚ /tools   â”‚  Routes  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Service Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Agent System (LangGraph)                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚ChatGraph â”‚  â”‚ReactGraphâ”‚  â”‚RouterGraphâ”‚                â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ â”‚
â”‚  â”‚                        â–¼                                   â”‚ â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚ â”‚
â”‚  â”‚              â”‚  Tool Registry   â”‚                          â”‚ â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     LLM Service         â”‚                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  Multi-Provider Router                          â”‚        â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ OpenAI  â”œâ”€â”€ Anthropic â”œâ”€â”€ DeepSeek          â”‚        â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ DashScope  â””â”€â”€ Ollama                      â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚AuthService   â”‚  â”‚MemoryService â”‚  â”‚ToolService   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚    Redis     â”‚  â”‚   Storage    â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ - Users      â”‚  â”‚ - Cache      â”‚  â”‚ - Local      â”‚          â”‚
â”‚  â”‚ - Sessions   â”‚  â”‚ - Context    â”‚  â”‚ - MinIO      â”‚          â”‚
â”‚  â”‚ - Checkpointsâ”‚  â”‚ - Rate Limit â”‚  â”‚ - COS        â”‚          â”‚
â”‚  â”‚ - Messages   â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Observability Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  structlog   â”‚  â”‚  Langfuse    â”‚  â”‚  Prometheus  â”‚          â”‚
â”‚  â”‚  (æ—¥å¿—)       â”‚  â”‚  (è¿½è¸ª)       â”‚  â”‚  (æŒ‡æ ‡)       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç›®å½•ç»“æ„è®¾è®¡

```
app/
â”œâ”€â”€ api/                      # API è·¯ç”±å±‚
â”‚   â””â”€â”€ v1/                  # API v1 ç‰ˆæœ¬
â”‚       â”œâ”€â”€ __init__.py      # è·¯ç”±æ³¨å†Œ
â”‚       â”œâ”€â”€ chat.py          # èŠå¤© API
â”‚       â”œâ”€â”€ auth.py          # è®¤è¯ API
â”‚       â”œâ”€â”€ tools.py         # å·¥å…· API
â”‚       â”œâ”€â”€ agents.py        # Agent API
â”‚       â””â”€â”€ evaluation.py    # è¯„ä¼° API
â”‚
â”œâ”€â”€ core/                     # æ ¸å¿ƒæ¨¡å—ï¼ˆæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼‰
â”‚   â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†ï¼ˆç¯å¢ƒæ„ŸçŸ¥ï¼‰
â”‚   â”œâ”€â”€ auth.py              # JWT è®¤è¯æˆæƒ
â”‚   â”œâ”€â”€ middleware.py        # FastAPI ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ dependencies.py      # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ errors.py            # é”™è¯¯åˆ†ç±»å’Œå¤„ç†
â”‚   â”œâ”€â”€ limiter.py           # é™æµå™¨
â”‚   â”œâ”€â”€ memory.py            # ä¼šè¯è®°å¿†ç®¡ç†
â”‚   â”œâ”€â”€ search.py            # æœç´¢åŠŸèƒ½
â”‚   â””â”€â”€ evaluation/          # è¯„ä¼°æ¨¡å—
â”‚       â”œâ”€â”€ runner.py        # è¯„ä¼°è¿è¡Œå™¨
â”‚       â”œâ”€â”€ datasets.py      # æ•°æ®é›†ç®¡ç†
â”‚       â”œâ”€â”€ evaluators.py    # è¯„ä¼°å™¨
â”‚       â””â”€â”€ report.py        # æŠ¥å‘Šç”Ÿæˆ
â”‚
â”œâ”€â”€ agent/                    # Agent æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py          # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ agent.py             # LangGraphAgent é—¨é¢ç±»
â”‚   â”œâ”€â”€ factory.py           # Agent å·¥å‚
â”‚   â”œâ”€â”€ state.py             # Agent çŠ¶æ€å®šä¹‰
â”‚   â”œâ”€â”€ checkpoint.py        # æ£€æŸ¥ç‚¹ç®¡ç†
â”‚   â”œâ”€â”€ state_manager.py     # çŠ¶æ€ç®¡ç†å™¨
â”‚   â”œâ”€â”€ examples.py          # ç¤ºä¾‹ä»£ç 
â”‚   â”‚
â”‚   â”œâ”€â”€ graphs/              # LangGraph å·¥ä½œæµ
â”‚   â”‚   â”œâ”€â”€ base.py          # åŸºç¡€å›¾æŠ½è±¡
â”‚   â”‚   â”œâ”€â”€ chat.py          # åŸºç¡€å¯¹è¯å›¾
â”‚   â”‚   â”œâ”€â”€ react.py         # ReAct æ¨¡å¼å›¾
â”‚   â”‚   â”œâ”€â”€ nodes.py         # èŠ‚ç‚¹å‡½æ•°
â”‚   â”‚   â””â”€â”€ routes.py        # è·¯ç”±å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ tools/               # å·¥å…·ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ registry.py      # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”‚   â””â”€â”€ builtin/         # å†…ç½®å·¥å…·
â”‚   â”‚       â”œâ”€â”€ calculation.py
â”‚   â”‚       â”œâ”€â”€ database.py
â”‚   â”‚       â”œâ”€â”€ search.py
â”‚   â”‚       â”œâ”€â”€ weather.py
â”‚   â”‚       â””â”€â”€ mcp.py       # MCP å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ multi_agent/         # å¤š Agent ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ supervisor.py    # ç›‘ç£è€…æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ router.py        # è·¯ç”±æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ handoff.py       # äº¤æ¥æ¨¡å¼
â”‚   â”‚   â””â”€â”€ swarm.py         # ç¾¤ä½“æ¨¡å¼
â”‚   â”‚
â”‚   â”œâ”€â”€ memory/              # è®°å¿†ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ base.py          # åŸºç¡€è®°å¿†
â”‚   â”‚   â”œâ”€â”€ short_term.py    # çŸ­æœŸè®°å¿†
â”‚   â”‚   â”œâ”€â”€ long_term.py     # é•¿æœŸè®°å¿†
â”‚   â”‚   â””â”€â”€ manager.py       # è®°å¿†ç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ callbacks/           # å›è°ƒå¤„ç†å™¨
â”‚   â”œâ”€â”€ prompts/             # æç¤ºæ¨¡æ¿
â”‚   â””â”€â”€ schemas.py           # Agent æ¨¡å¼å®šä¹‰
â”‚
â”œâ”€â”€ llm/                      # LLM æœåŠ¡
â”‚   â”œâ”€â”€ __init__.py          # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ service.py           # LLM æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ providers.py         # æ¨¡å‹æä¾›å•†
â”‚   â”œâ”€â”€ registry.py          # æ¨¡å‹æ³¨å†Œè¡¨
â”‚   â””â”€â”€ embeddings.py        # åµŒå…¥æœåŠ¡
â”‚
â”œâ”€â”€ infra/                    # åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ __init__.py          # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ redis.py             # Redis å®¢æˆ·ç«¯
â”‚   â””â”€â”€ storage.py           # å¯¹è±¡å­˜å‚¨
â”‚
â”œâ”€â”€ observability/            # å¯è§‚æµ‹æ€§
â”‚   â”œâ”€â”€ __init__.py          # æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ logging.py           # æ—¥å¿—é…ç½®
â”‚   â””â”€â”€ metrics.py           # æŒ‡æ ‡æ”¶é›†
â”‚
â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹ï¼ˆSQLModelï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ user.py
â”‚   â”œâ”€â”€ agent.py
â”‚   â””â”€â”€ database.py
â”‚
â”œâ”€â”€ schemas/                  # Pydantic æ¨¡å¼ï¼ˆè¯·æ±‚/å“åº”ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ auth.py
â”‚   â””â”€â”€ chat.py
â”‚
â”œâ”€â”€ repositories/             # æ•°æ®è®¿é—®å±‚ï¼ˆRepository æ¨¡å¼ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py
â”‚   â”œâ”€â”€ user.py
â”‚   â”œâ”€â”€ agent.py
â”‚   â”œâ”€â”€ session.py
â”‚   â”œâ”€â”€ thread.py
â”‚   â””â”€â”€ message.py
â”‚
â”œâ”€â”€ services/                 # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ database.py
â”‚
â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ __init__.py
â”‚
â””â”€â”€ main.py                   # åº”ç”¨å…¥å£
```

---

## ä¸‰ã€æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 Agent ç³»ç»Ÿ (app/agent/)

#### 3.1.1 LangGraphAgent é—¨é¢ç±»

```python
class LangGraphAgent:
    """LangGraph Agent ç®¡ç†ç±»

    æä¾›å®Œæ•´çš„ Agent åŠŸèƒ½ï¼š
    - å›¾åˆ›å»ºå’Œç¼–è¯‘
    - åŒæ­¥/å¼‚æ­¥å“åº”è·å–
    - æµå¼å“åº”
    - èŠå¤©å†å²ç®¡ç†
    - PostgreSQL æ£€æŸ¥ç‚¹æŒä¹…åŒ–
    """

    async def get_response(
        self,
        message: str,
        session_id: str,
        user_id: str | None = None,
    ) -> list[BaseMessage]:
        """è·å– Agent å“åº”"""

    async def get_stream_response(
        self,
        message: str,
        session_id: str,
        user_id: str | None = None,
    ) -> AsyncIterator[str]:
        """è·å–æµå¼å“åº”"""

    async def get_chat_history(
        self,
        session_id: str,
    ) -> list[BaseMessage]:
        """è·å–èŠå¤©å†å²"""
```

#### 3.1.2 å›¾ç±»å‹

| å›¾ç±»å‹ | æ–‡ä»¶ | ç”¨é€” |
|--------|------|------|
| **ChatGraph** | `graph/builder.py` | åŸºç¡€å¯¹è¯ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨ |
| **ReactGraph** | `graph/react.py` | ReAct æ¨ç†æ¨¡å¼ |
| **RouterGraph** | `multi_agent/router.py` | è·¯ç”±åˆ°ä¸åŒå­ Agent |
| **SupervisorGraph** | `multi_agent/supervisor.py` | ç›‘ç£è€…åè°ƒå¤š Agent |
| **SwarmGraph** | `multi_agent/swarm.py` | ç¾¤ä½“åä½œæ¨¡å¼ |

#### 3.1.3 çŠ¶æ€ç®¡ç†

```python
class AgentState(TypedDict):
    """Agent çŠ¶æ€å®šä¹‰

    ä½¿ç”¨ add_messages reducer è‡ªåŠ¨å¤„ç†æ¶ˆæ¯è¿½åŠ ã€‚
    """
    messages: Annotated[list[BaseMessage], add_messages]
    user_id: str | None
    session_id: str
    iteration_count: int  # é˜²æ­¢æ— é™å¾ªç¯
    max_iterations: int
```

#### 3.1.4 å·¥å…·æ³¨å†Œè¡¨

```python
# å·¥å…·æ³¨å†Œ
from app.agent.tools import tool

@tool
async def my_calculator(a: int, b: int) -> str:
    """è®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œ"""
    return f"{a} + b} = {a + b}"

# è‡ªåŠ¨æ³¨å†Œåˆ°å…¨å±€æ³¨å†Œè¡¨
```

### 3.2 LLM æœåŠ¡ (app/llm/)

#### 3.2.1 LLMService

```python
class LLMService:
    """LLM æœåŠ¡

    æä¾› LLM è°ƒç”¨ã€é‡è¯•å’Œå¾ªç¯å›é€€å®¹é”™ã€‚
    """

    async def call(
        self,
        messages: list[BaseMessage],
        model_name: str | None = None,
        **kwargs,
    ) -> BaseMessage:
        """è°ƒç”¨ LLMï¼Œè‡ªåŠ¨é‡è¯•å’Œå›é€€"""

    def bind_tools(self, tools: list[Any]) -> "LLMService":
        """ç»‘å®šå·¥å…·"""

    def with_structured_output(self, schema: type[T]) -> BaseChatModel:
        """ç»“æ„åŒ–è¾“å‡º"""

    def get_llm_for_task(
        self,
        priority: str = "balanced",
    ) -> BaseChatModel:
        """æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§è·å– LLM"""
```

#### 3.2.2 æ”¯æŒçš„æä¾›å•†

| æä¾›å•† | æ¨¡å‹ç¤ºä¾‹ | ç”¨é€” |
|--------|----------|------|
| OpenAI | gpt-4o, gpt-4o-mini | é€šç”¨ |
| Anthropic | claude-opus, claude-sonnet | é«˜è´¨é‡ |
| DeepSeek | deepseek-chat | æˆæœ¬ä¼˜åŒ– |
| DashScope | qwen-turbo, qwen-plus | å›½äº§ |
| Ollama | llama3, mistral | æœ¬åœ° |

### 3.3 é…ç½®ç®¡ç† (app/core/config.py)

#### 3.3.1 ç¯å¢ƒæ„ŸçŸ¥é…ç½®

```python
class Environment(str, Enum):
    """ç¯å¢ƒç±»å‹"""
    DEVELOPMENT = "development"
    STAGING = "staging"
    PRODUCTION = "production"
    TEST = "test"

class Settings(BaseSettings):
    """åº”ç”¨é…ç½® - ç¯å¢ƒå˜é‡é©±åŠ¨

    ç¯å¢ƒå˜é‡å‘½åè§„èŒƒï¼šKIKI_<SECTION>_<KEY>
    ä¾‹å¦‚: KIKI_LLM_API_KEY, KIKI_DATABASE_URL
    """

    # LLM é…ç½®
    llm_provider: Literal["openai", "anthropic", "ollama", "dashscope", "deepseek"]
    llm_model: str
    llm_api_key: str | None

    # æ•°æ®åº“é…ç½®
    database_url: str
    database_pool_size: int = 20

    # Agent é…ç½®
    agent_max_messages: int = 100
    agent_max_iterations: int = 50
    agent_max_retries: int = 3
```

### 3.4 ä¸­é—´ä»¶ (app/core/middleware.py)

#### 3.4.1 ObservabilityMiddleware

- è¯·æ±‚æ—¥å¿—è®°å½•ï¼ˆç»“æ„åŒ–ï¼‰
- è¯·æ±‚ ID æ³¨å…¥
- å“åº”æ—¶é—´è®°å½•
- Prometheus æŒ‡æ ‡æ”¶é›†

#### 3.4.2 RequestContextMiddleware

- ç”¨æˆ·ä¸Šä¸‹æ–‡æ³¨å…¥
- è¯·æ±‚å…ƒæ•°æ®ç®¡ç†

### 3.5 é”™è¯¯å¤„ç† (app/core/errors.py)

#### 3.5.1 é”™è¯¯åˆ†ç±»

```python
class ErrorCategory(str, Enum):
    """é”™è¯¯ç±»åˆ«"""
    VALIDATION = "validation"      # è¾“å…¥éªŒè¯é”™è¯¯
    AUTHENTICATION = "auth"        # è®¤è¯é”™è¯¯
    AUTHORIZATION = "permission"   # æˆæƒé”™è¯¯
    NOT_FOUND = "not_found"        # èµ„æºæœªæ‰¾åˆ°
    RATE_LIMIT = "rate_limit"      # é™æµ
    EXTERNAL_API = "external_api"  # å¤–éƒ¨ API é”™è¯¯
    DATABASE = "database"          # æ•°æ®åº“é”™è¯¯
    UNKNOWN = "unknown"            # æœªçŸ¥é”™è¯¯
```

---

## å››ã€æ•°æ®æµè®¾è®¡

### 4.1 èŠå¤©è¯·æ±‚æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ POST /api/v1/chat/stream
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI                                                    â”‚
â”‚  â”œâ”€â”€ 1. RequestContextMiddleware (æ³¨å…¥ request_id)         â”‚
â”‚  â”œâ”€â”€ 2. RateLimitMiddleware (æ£€æŸ¥é™æµ)                      â”‚
â”‚  â”œâ”€â”€ 3. AuthMiddleware (éªŒè¯ JWT)                          â”‚
â”‚  â””â”€â”€ 4. ObservabilityMiddleware (å¼€å§‹è®¡æ—¶)                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chat Handler (app/api/v1/chat.py)                         â”‚
â”‚  1. åˆ›å»º AgentState                                         â”‚
â”‚  2. è·å–æˆ–åˆ›å»º Graph (ä½¿ç”¨ç¼“å­˜)                             â”‚
â”‚  3. é…ç½® RunnableConfig (thread_id, metadata)              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LangGraph Execution                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Checkpointer: åŠ è½½/åˆ›å»ºæ£€æŸ¥ç‚¹ (PostgreSQL)        â”‚   â”‚
â”‚  â”‚ 2. chat_node:                                        â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ æ„å»º Prompt (system + messages)              â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ LLM è°ƒç”¨ (å¸¦é‡è¯•)                             â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è¿”å› AI æ¶ˆæ¯                                  â”‚   â”‚
â”‚  â”‚ 3. route_by_tools: æ£€æŸ¥æ˜¯å¦æœ‰ tool_calls            â”‚   â”‚
â”‚  â”‚    â””â”€â”€ å¦‚æœæœ‰: è·¯ç”±åˆ° tools èŠ‚ç‚¹                     â”‚   â”‚
â”‚  â”‚ 4. tools_node:                                       â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ æ‰§è¡Œå·¥å…·è°ƒç”¨                                  â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è¿”å›å·¥å…·ç»“æœ                                  â”‚   â”‚
â”‚  â”‚ 5. å¾ªç¯å›åˆ° chat_nodeï¼Œç›´åˆ°æ²¡æœ‰ tool_calls           â”‚   â”‚
â”‚  â”‚ 6. ä¿å­˜æ£€æŸ¥ç‚¹                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SSE Streaming                                              â”‚
â”‚  â”œâ”€â”€ 1. astream() è¿­ä»£ç»“æœ                                  â”‚
â”‚  â”œâ”€â”€ 2. æ ¼å¼åŒ–ä¸º SSE äº‹ä»¶                                   â”‚
â”‚  â””â”€â”€ 3. å‘é€ token/update/done äº‹ä»¶                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ObservabilityMiddleware                                    â”‚
â”‚  â”œâ”€â”€ è®°å½•è¯·æ±‚æ—¥å¿—                                           â”‚
â”‚  â”œâ”€â”€ æ”¶é›† Prometheus æŒ‡æ ‡                                   â”‚
â”‚  â””â”€â”€ Langfuse è¿½è¸ª                                         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Responseâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å¤š Agent åä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Router Agent Pattern                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   User Input                                                â”‚
â”‚      â”‚                                                      â”‚
â”‚      â–¼                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚   â”‚ Router Agent â”‚ â† åˆ†æç”¨æˆ·æ„å›¾ï¼Œå†³å®šè·¯ç”±åˆ°å“ªä¸ªå­ Agent  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚          â”‚                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”                              â”‚
â”‚    â–¼     â–¼     â–¼     â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                                  â”‚
â”‚  â”‚ S â”‚ â”‚ s â”‚ â”‚ s â”‚ â”‚ s â”‚  Sub-Agents                       â”‚
â”‚  â”‚ a â”‚ â”‚ u â”‚ â”‚ w â”‚ â”‚ g â”‚  - Sales Agent                   â”‚
â”‚  â”‚ l â”‚ â”‚ p â”‚ â”‚ e â”‚ â”‚ e â”‚  - Support Agent                 â”‚
â”‚  â”‚ e â”‚ â”‚ p â”‚ â”‚ a â”‚  â”‚ n â”‚  - Weather Agent                â”‚
â”‚  â”‚ s â”‚ â”‚ o â”‚ â”‚ t â”‚  â”‚ e â”‚  - General Agent                â”‚
â”‚  â”‚   â”‚ â”‚ r â”‚ â”‚ h â”‚  â”‚ r â”‚                                  â”‚
â”‚  â”‚   â”‚ â”‚ t â”‚ â”‚ e â”‚  â”‚ a â”‚                                  â”‚
â”‚  â”‚   â”‚ â”‚   â”‚ â”‚ r â”‚  â”‚ l â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                                  â”‚
â”‚          â”‚                                                  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â–º å›å¤ç”¨æˆ·                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å…³é”®æŠ€æœ¯å†³ç­–

### 5.1 ä¸ºä»€ä¹ˆé€‰æ‹© LangGraphï¼Ÿ

| å†³ç­–ç‚¹ | ç†ç”± |
|--------|------|
| **çŠ¶æ€ç®¡ç†** | å†…ç½®çŠ¶æ€æŒä¹…åŒ–ï¼Œæ”¯æŒæ£€æŸ¥ç‚¹å’Œæ¢å¤ |
| **æµå¼å“åº”** | åŸç”Ÿæ”¯æŒæµå¼è¾“å‡ºï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½ |
| **å¯è§†åŒ–** | LangGraph Studio å¯è§†åŒ–è°ƒè¯• |
| **ç”Ÿäº§å°±ç»ª** | LinkedInã€Uber ç­‰ 400+ å…¬å¸ä½¿ç”¨ |
| **ç”Ÿæ€ç³»ç»Ÿ** | ä¸ LangChain æ·±åº¦é›†æˆï¼Œå·¥å…·ä¸°å¯Œ |

### 5.2 ä¸ºä»€ä¹ˆä½¿ç”¨ PostgreSQL æ£€æŸ¥ç‚¹ï¼Ÿ

| ç‰¹æ€§ | MemorySaver | PostgresSaver |
|------|-------------|---------------|
| æŒä¹…åŒ– | âŒ è¿›ç¨‹é‡å¯ä¸¢å¤± | âœ… æ°¸ä¹…å­˜å‚¨ |
| åˆ†å¸ƒå¼ | âŒ å•æœº | âœ… æ”¯æŒå¤šå®ä¾‹ |
| æŸ¥è¯¢ | âŒ æ— æ³•æŸ¥è¯¢ | âœ… SQL æŸ¥è¯¢ |
| å¤æ‚åº¦ | ä½ | ä¸­ |

### 5.3 ä¸ºä»€ä¹ˆä½¿ç”¨ uv è€Œé pip/condaï¼Ÿ

| ç‰¹æ€§ | uv | pip | poetry |
|------|-----|-----|--------|
| é€Ÿåº¦ | âš¡ï¸ æå¿« | ğŸŒ æ…¢ | ğŸš€ å¿« |
| é”æ–‡ä»¶ | âœ… uv.lock | âŒ | âœ… poetry.lock |
| å…¼å®¹æ€§ | âœ… pip å…¼å®¹ | - | âš ï¸ éƒ¨åˆ†å…¼å®¹ |
| é¡¹ç›®ç®¡ç† | âœ… å†…ç½® | âŒ | âœ… å†…ç½® |

### 5.4 ä¸ºä»€ä¹ˆä½¿ç”¨ structlogï¼Ÿ

```python
# æ ‡å‡†åº“ logging
logger.info("User logged in", extra={"user_id": 123})
# è¾“å‡º: INFO:__main__:User logged in

# structlog
logger.info("user_logged_in", user_id=123, ip="1.2.3.4")
# è¾“å‡º: {"event": "user_logged_in", "user_id": 123, "ip": "1.2.3.4", "level": "info"}
```

**ä¼˜åŠ¿ï¼š**
- ç»“æ„åŒ–è¾“å‡ºï¼Œä¾¿äºæ—¥å¿—èšåˆ
- è‡ªåŠ¨ç»‘å®šä¸Šä¸‹æ–‡ï¼ˆrequest_id, user_idï¼‰
- æ”¯æŒå¤šç§æ ¼å¼ï¼ˆJSONã€Consoleï¼‰
- æ›´å¥½çš„æ€§èƒ½

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 6.1 è¿æ¥æ± é…ç½®

```python
# PostgreSQL è¿æ¥æ± 
database_pool_size: int = 20  # æ ¹æ® DB è¿æ¥æ•°è°ƒæ•´

# Redis è¿æ¥æ± 
redis_pool_size: int = 10
```

### 6.2 ç¼“å­˜ç­–ç•¥

| ç¼“å­˜ç±»å‹ | å­˜å‚¨ä½ç½® | TTL | ç”¨é€” |
|----------|----------|-----|------|
| LLM å“åº”ç¼“å­˜ | Redis | 1h | ç›¸åŒé—®é¢˜å¿«é€Ÿå“åº” |
| ä¼šè¯ä¸Šä¸‹æ–‡ | Redis | 24h | èŠå¤©å†å²ç¼“å­˜ |
| å·¥å…·åˆ—è¡¨ | å†…å­˜ | å¯åŠ¨æ—¶ | å·¥å…·æ³¨å†Œè¡¨ç¼“å­˜ |
| å›¾å®ä¾‹ | å†…å­˜ | å¯åŠ¨æ—¶ | Graph ç¼–è¯‘ç¼“å­˜ |

### 6.3 å¼‚æ­¥ I/O

- å…¨å¼‚æ­¥æ¶æ„ (async/await)
- ä½¿ç”¨ `asyncpg` æ›¿ä»£ `psycopg2`
- ä½¿ç”¨ `hiredis` åŠ é€Ÿ Redis

---

## ä¸ƒã€å®‰å…¨è®¾è®¡

### 7.1 è®¤è¯æˆæƒ

- JWT Token è®¤è¯
- Access Token (30 åˆ†é’Ÿ) + Refresh Token (7 å¤©)
- å¯†ç ä½¿ç”¨ bcrypt å“ˆå¸Œ

### 7.2 é™æµç­–ç•¥

- ä»¤ç‰Œæ¡¶ç®—æ³•
- åŸºäº Redis åˆ†å¸ƒå¼é™æµ
- æŒ‰ IP/ç”¨æˆ·ç»´åº¦é™æµ

### 7.3 æ•°æ®å®‰å…¨

- ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- æ—¥å¿—è„±æ•ï¼ˆæ‰‹æœºå·ã€é‚®ç®±ï¼‰
- ç”Ÿäº§ç¯å¢ƒä¸è¿”å›è¯¦ç»†é”™è¯¯

---

## å…«ã€ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### 8.1 æ—¥å¿—

| çº§åˆ« | ç”¨é€” |
|------|------|
| DEBUG | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ |
| INFO | å…³é”®ä¸šåŠ¡æµç¨‹ |
| WARNING | å¯æ¢å¤çš„å¼‚å¸¸ |
| ERROR | éœ€è¦å…³æ³¨çš„é”™è¯¯ |

### 8.2 æŒ‡æ ‡

| æŒ‡æ ‡ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `http_requests_total` | Counter | è¯·æ±‚æ€»æ•° |
| `http_request_duration` | Histogram | è¯·æ±‚è€—æ—¶ |
| `llm_calls_total` | Counter | LLM è°ƒç”¨æ•° |
| `llm_token_usage` | Gauge | Token ä½¿ç”¨é‡ |

### 8.3 è¿½è¸ª

- Langfuse è‡ªåŠ¨è¿½è¸ª LLM è°ƒç”¨
- åˆ†å¸ƒå¼è¿½è¸ªæ”¯æŒ
- æˆæœ¬åˆ†æ

---

## ä¹ã€éƒ¨ç½²æ¶æ„

### 9.1 å¼€å‘ç¯å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Docker Compose                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  App    â”‚  â”‚   DB    â”‚  â”‚  Redis  â”‚              â”‚
â”‚  â”‚ :8000   â”‚  â”‚ :5432   â”‚  â”‚  :6379  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 ç”Ÿäº§ç¯å¢ƒ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Nginx     â”‚
                    â”‚   (LB)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                 â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  App 1  â”‚        â”‚  App 2  â”‚        â”‚  App N  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                  â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            PostgreSQL               â”‚
         â”‚  (ä¸»ä»å¤åˆ¶ / è¿æ¥æ± )                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              Redis                  â”‚
         â”‚  (å“¨å…µæ¨¡å¼ / é›†ç¾¤)                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åã€å‚è€ƒèµ„æº

- [LangGraph æ–‡æ¡£](https://langchain-ai.github.io/langgraph/)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [structlog æ–‡æ¡£](https://www.structlog.org/)
- [Langfuse æ–‡æ¡£](https://langfuse.com/)
